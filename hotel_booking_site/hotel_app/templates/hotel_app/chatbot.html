<!-- chatbot.html -->
{% load static %}

<!-- Floating Chat Icon -->
<button class="chat-float" onclick="toggleChat()">ğŸ’¬</button>

<!-- Chatbot Container -->
<div class="chat-container" id="chatbot">
  <div class="chat-header">ğŸ¨ Hotel Assistant</div>

  <div id="chat-box" class="chat-box">
    <div class="bot-message">
      Hello ğŸ‘‹ I'm your hotel assistant! Ask me any hotel name in MP.
    </div>
  </div>

  <div class="chat-input">
    <input type="text" id="user-input" placeholder="Type hotel name...">
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<style>
  .chat-container {
    width: 320px;
    height: 420px;
    background: #fff;
    border-radius: 15px;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
    position: fixed;
    bottom: 85px;
    right: 25px;
    display: none;
    flex-direction: column;
    justify-content: space-between;
    overflow: hidden;
    font-family: 'Poppins', sans-serif;
    z-index: 99999;
  }

  .chat-header {
    background: #007bff;
    color: white;
    padding: 10px;
    font-weight: bold;
    text-align: center;
  }

  .chat-box {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
    font-size: 14px;
  }

  .chat-input {
    display: flex;
    border-top: 1px solid #ccc;
  }

  .chat-input input {
    flex: 1;
    border: none;
    padding: 10px;
    outline: none;
  }

  .chat-input button {
    background: #007bff;
    border: none;
    color: white;
    padding: 10px;
    cursor: pointer;
  }

  .chat-float {
    position: fixed;
    bottom: 25px;
    right: 25px;
    background: #007bff;
    border-radius: 50%;
    color: white;
    width: 55px;
    height: 55px;
    font-size: 24px;
    border: none;
    cursor: pointer;
    box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    z-index: 99999;
  }

  .user-message,
  .bot-message {
    padding: 8px 10px;
    border-radius: 10px;
    margin: 5px 0;
    max-width: 80%;
    line-height: 1.4;
  }

  .user-message {
    background: #007bff;
    color: white;
    margin-left: auto;
  }

  .bot-message {
    background: #f1f1f1;
  }
</style>
<script>
  let hotels = [];

  // âœ… Load and parse CSV properly (handles commas inside quotes)
  fetch("{% static 'data/hotels.csv' %}")
    .then(response => response.text())
    .then(data => {
      let lines = data.trim().split("\n").slice(1);

      lines.forEach(line => {
        // Match CSV with quotes properly
        let cols = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
        if (cols && cols.length >= 8) {
          hotels.push({
            name: cols[0].replace(/"/g, '').trim().toLowerCase(),
            city: cols[1].replace(/"/g, '').trim(),
            address: cols[2].replace(/"/g, '').trim(),
            rating: cols[3].replace(/"/g, '').trim(),
            price: cols[4].replace(/"/g, '').trim(),
            rooms: cols[5].replace(/"/g, '').trim(),
            amenities: cols[6].replace(/"/g, '').trim()
          });
        }
      });
      console.log("âœ… Hotels loaded:", hotels.length);
    })
    .catch(err => console.error("CSV load error:", err));

  function toggleChat() {
    const chat = document.getElementById("chatbot");
    chat.style.display = chat.style.display === "flex" ? "none" : "flex";
  }

  function sendMessage() {
    const input = document.getElementById("user-input");
    const chatBox = document.getElementById("chat-box");
    const userMessage = input.value.trim();
    if (!userMessage) return;

    chatBox.innerHTML += `<div class="user-message">${userMessage}</div>`;
    input.value = "";

    let botReply = getBotReply(userMessage.toLowerCase());
    setTimeout(() => {
      chatBox.innerHTML += `<div class="bot-message">${botReply}</div>`;
      chatBox.scrollTop = chatBox.scrollHeight;
    }, 400);
  }

  function getBotReply(message) {
    let found = hotels.find(
      h => message.includes(h.name) || message.includes(h.city.toLowerCase())
    );

    if (found) {
      return `
        âœ… <b>${capitalize(found.name)}</b> (${found.city}) available hai.<br>
        ğŸ“ <b>Address:</b> ${found.address}<br>
        â­ <b>Rating:</b> ${found.rating}<br>
        ğŸ’° <b>Price:</b> â‚¹${found.price}/night<br>
        ğŸ›ï¸ <b>Rooms:</b> ${found.rooms}<br>
        ğŸ¯ <b>Amenities:</b> ${found.amenities}
      `;
    } else if (message.includes("hello") || message.includes("hi")) {
      return "Hello bhai ğŸ‘‹! Hotel ka naam likh ke availability check kar.";
    } else {
      return "âŒ Sorry bhai, ye hotel humare list me available nahi hai.";
    }
  }

  function capitalize(text) {
    return text.charAt(0).toUpperCase() + text.slice(1);
  }
</script>
